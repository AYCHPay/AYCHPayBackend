<style>
	#message {
		display:none;
	}
	#refresh {
		visibility:hidden;
		position:absolute;
		left:-100000px;
		top:-100000px;
	}
	#sorry {
		visibility:hidden;
		position:absolute;
		left:-100000px;
		top:-100000px;
	}
</style>
<script language="JavaScript" type="text/javascript" src="static/js/keys.js"></script>
<script>
	$(".aside .nav li").removeClass("active");
	$(".anonym, .anonym_citizen_status").addClass("active");
	
//	$( "#dl_modal" ).load( "content?controllerHTML=modal_anonym", { }, function() {});
	
	$('#countries').select2({
		theme: 'bootstrap'
	});
	
	var arr = [];
	var container = $("#fields");
	var msg = $("#message");
	var btn = $("#send");
	
	function Country(id) {
		if (!id) {
			id = 1;
		}
		
		container.html("");
		$("#refresh").click();
		
		$.ajax({
			type: 'GET',
			url: 'ajax?json=ajax_citizen_fields',
			data: {
				'state_id' : id
			},
			dataType: 'json',
			crossDomain: true,
			success: function(data) {
				arr = [];
				btn.prop("disabled", false);
				$('[data-sweet-alert]').removeClass("whirl standard");
				container.prepend('<div class="form-group"><label for="price">Price</label><input id="price" type="text" class="form-control" value="' + data.price + ' DLT" disabled></div>');
				if (data.valid == false) {
					$("#sorry").click();
					btn.prop("disabled", true);
					//container.find(".form-group").hide();
				} else {
					//container.find(".form-group").show();
				}
				if (data.fields.length) {
					var fields = JSON.parse(data.fields);
					
					for (i = 0; i < fields.length; i++ ) {
						if (fields[i].htmlType == "textinput") {
							var el = '<div class="form-group"><label for="' + fields[i].name + '">' + fields[i].title + '</label><input id="' + fields[i].name + '" name="' + fields[i].name + '" type="text" class="form-control"></div>'
						}
						if (fields[i].htmlType == "calendar") {
							var el = '<div class="form-group"><label for="' + fields[i].name + '">' + fields[i].title + '</label><div class="input-group date datetimepicker"><input id="' + fields[i].name + '" type="text" class="form-control"><span class="input-group-addon"><span class="fa fa-calendar"></span></span></div></div>'
						}
						if (fields[i].htmlType == "file") {
							var el = '<div class="form-group"><label for="' + fields[i].name + '">' + fields[i].title + '</label><input id="' + fields[i].name + '" type="file" accept="image/*" data-classbutton="btn btn-default" data-classinput="form-control inline" class="form-control filestyle"></div>'
						}
						container.append(el);
						arr.push(fields[i].name);
					}
					$(".datetimepicker").datetimepicker({
						icons: {
							time: 'fa fa-clock-o',
							date: 'fa fa-calendar',
							up: 'fa fa-chevron-up',
							down: 'fa fa-chevron-down',
							previous: 'fa fa-chevron-left',
							next: 'fa fa-chevron-right',
							today: 'fa fa-crosshairs',
							clear: 'fa fa-trash'
						},
						minDate: moment("01/01/1950"),
						maxDate: 'now',
						format: 'DD MMMM, YYYY'
					});
					$(".filestyle").filestyle();
					
					console.log(fields)
					console.log(arr)
				}
			},
			error: function(xhr, status, error) {
				Alert("Error", error, "error");
			}
		});
	}
	
	function changeCountry(elem) {
		var id = elem.value;
		if (id != "1") {
			msg.show();
			container.html("");
			//container.find(".form-group").hide();
			//container.find("#price").parent().remove();
			btn.prop("disabled", true);
		} else {
			msg.hide();
			Country(id);
		}
	}
	
	Country();
	// Example of ajax_citizen_fields
	/*$.get( 'ajax?json=ajax_citizen_fields',{state_id: 1}, function(data) {
		console.log(data);
		if (data.fields.length) {
			var fields = JSON.parse(data.data);
			alert(fields[0].name +', ' + fields[0].title + ', ' + 
			fields[0].txType +', ' + fields[0].htmlType	 );
			console.log( fields );
		}
	},'json')*/
	
	/**=========================================================
	 * Module: notify.js
	 * Create toggleable notifications that fade out automatically.
	 * Based on Notify addon from UIKit (http://getuikit.com/docs/addons_notify.html)
	 * [data-toggle="notify"]
	 * [data-options="options in json format" ]
	 =========================================================*/
	
	(function($, window, document){
	  'use strict';
	
	  var Selector = '[data-notify]',
		  autoloadSelector = '[data-onload]',
		  doc = $(document);
	
	
	  $(function() {
	
		$(Selector).each(function(){
	
		  var $this  = $(this),
			  onload = $this.data('onload');
	
		  if(onload !== undefined) {
			setTimeout(function(){
			  notifyNow($this);
			}, 800);
		  }
	
		  $this.on('click', function (e) {
			e.preventDefault();
			notifyNow($this);
		  });
	
		});
	
	  });
	
	  function notifyNow($element) {
		  var message = $element.data('message'),
			  options = $element.data('options');
	
		  if(!message)
			$.error('Notify: No message specified');
		 
		  $.notify(message, options || {});
	  }
	
	
	}(jQuery, window, document));

	var serverTime;
	
	$('#send').bind('click', function () {
		if (!$("#phrase").val()) {
			alert('Generate seed');
			return;
		}
		$.get( 'ajax?controllerName=GetServerTime', function (data) {
			serverTime = data.time;
			$("#for-signature").val( '{{.TxTypeId}},'+serverTime+',{{.Data.WalletId}}');
			doSign();
			$("#send_to_net").trigger("click");
		}, "json" );
	} );

	$('#send_to_net').bind('click', function () {
		$.ajax({
			type: 'POST',
			url: 'ajax?controllerName=saveQueue',
			data: {
				'type' : '{{.TxType}}',
				'time' : serverTime,
				'walletId' : '{{.Data.WalletId}}',
				'stateId': $("#countries").val(),
				'pubkey' : GKey.Public,
				'signature1': $('#signature1').val(),
				'signature2': $('#signature2').val(),
				'signature3': $('#signature3').val()
			},
			dataType: 'json',
			crossDomain: true,
			success: function(result) {
				if (typeof result.error != "undefined" && result.error.length > 0 ) {
					Alert("Error", result.error, "error");
				} else {
					interval = setInterval(function() {
						$.ajax({
							type: 'POST',
							url: 'ajax?json=ajax_citizen_request',
							data: {state_id: $("#countries").val()},
							dataType: 'json',
							crossDomain: true,
							success: function(data){
								if (typeof data.error != "undefined" && data.error.length > 0) {
									Alert("Error", data.error, "error");
									clearInterval(interval);
								} else if (data.host.length > 0) {
									clearInterval(interval);
									$("#for-signature").val( 'CitizenInfo,'+data.time+',{{.Data.WalletId}}');
									doSign();
									do_generate();
									var key = $("#pubkey").val();
									if (key.length > 128) {
										key = key.substr( 2 );
									}
									var stateId = $("#countries").val();
									var predata = {
//										'type' : data.type_name,
										'time' : data.time,
										'walletId' : '{{.Data.WalletId}}',
										'stateId': stateId,
										'price': parseInt($("#price").val()),
										'publicKey': key,
										'pubkey' : GKey.Public,
										'signature1': $('#signature1').val(),
										'signature2': $('#signature2').val(),
										'signature3': $('#signature3').val()
									};
									
									for (i = 0; i < arr.length; i++ ) {
										var field = arr[i];
										predata[field] = $("#" + field).val();
									}
									
									//console.log(predata)
									$.ajax({
										type: 'POST',
										url: data.host + 'ajax?json=ajax_citizen_info',
										data: predata,
										dataType: 'json',
										crossDomain: true,
										success: function(status){
											localStorage.setItem('reqPrv', $("#prvkey").val());
											localStorage.setItem('reqState', stateId );
											localStorage.setItem('reqHost', data.host );
											if (typeof status.error != "undefined" && status.error.length > 0 ) {
												Alert("Error", status.error, "error");
											} else {
												Alert("Success", "", "success");
											}
										},
										error: function(xhr, status, error) {
											Alert("Error", error, "error");
										},
									});
								}
							},
							error: function(xhr, status, error) {
								clearInterval(interval);
								Alert("Error", error, "error");
							},
						});
					}, 2000)
				}
			},
			error: function(xhr, status, error) {
				Alert("Error", error, "error");
			}
		});
	} );	
	$(document).ready(function(){
		do_phrase();
	});
		
</script>

<div class="content-heading">
   Request for citizen status
</div>
<ol class="breadcrumb">
   <li><a href="#" onclick="dl_navigate0('dashboardAnonym')">Dashboard</a></li>
   <li class="active">Request for citizen status</li>
</ol>
<!-- START panel-->
<div class="panel panel-default" data-sweet-alert>
 <div class="panel-body">
	<form role="form">
	   <div class="form-group">
		  <label for="countries">Country</label>
		  <select id="countries" class="form-control" onChange="changeCountry(this);">
			 <option value="1">DayLight</option>
			 <option value="AL">Alabama</option>
			 <option value="AR">Arkansas</option>
			 <option value="IL">Illinois</option>
			 <option value="IA">Iowa</option>
			 <option value="KS">Kansas</option>
			 <option value="KY">Kentucky</option>
			 <option value="LA">Louisiana</option>
			 <option value="MN">Minnesota</option>
			 <option value="MS">Mississippi</option>
			 <option value="MO">Missouri</option>
			 <option value="OK">Oklahoma</option>
			 <option value="SD">South Dakota</option>
			 <option value="TX">Texas</option>
			 <option value="TN">Tennessee</option>
			 <option value="WI">Wisconsin</option>
		  </select>
	   </div>
	   <div id="message" class="alert alert-danger">At this point in your chosen country, the Central Bank has not yet begun to register citizens in DayLight. If the Central Bank does not begin to citizens registered to 03.01.2017,  then these powers led association of CB will be transferred.</div>
	   <div id="fields">
		   <!--<div class="form-group">
			  <label for="name">Name</label>
			  <input id="name" type="text" class="form-control">
		   </div>
		   <div class="form-group">
			  <label for="surname">Surname</label>
			  <input id="surname" type="text" class="form-control">
		   </div>
		   <div class="form-group">
			  <label for="birthday">Birthday</label>
			  <div id="datetimepicker1" class="input-group date">
				 <input id="birthday" type="text" class="form-control">
				 <span class="input-group-addon">
					<span class="fa fa-calendar"></span>
				 </span>
			  </div>
		   </div>
		   <div class="form-group">
			  <label for="photo">Photo</label>
			  <input id="photo" type="file" accept="image/*" data-classbutton="btn btn-default" data-classinput="form-control inline" class="form-control filestyle">
		   </div>
		   <div class="form-group">
			  <label for="passport">Passport number</label>
			  <input id="passport" type="text" class="form-control">
		   </div>-->
	   </div>
		   <div class="form-group" style="display:none;">
			  <label for="phrase">GENERATE AND REMEMBER SEED</label>
			  <textarea id="phrase" class="form-control"></textarea>
			 <!--button id="genseed" class="btn btn-default noimport" onclick="return do_phrase();">Generate new seed</button-->
			<input type="hidden" id="prvkey" value="" />
			<input type="hidden" id="pubkey" value="" />
			
		   </div>
	</form>
 </div>
 <div class="panel-footer">
   <div class="clearfix">
	  <div class="pull-right">
		 <button id="send" type="button" class="btn btn-primary" data-tool="panel-refresh" onClick="preloader(this);">Request</button>
		 <button id="refresh" type="button" data-tool="panel-refresh" onClick="preloader(this);"></button>
	  </div>
   </div>
  </div>
</div>
<!-- END panel-->
<button id="sorry" type="button" data-notify="" data-message="Insufficient funds in the account for the registration of the citizen." data-options="{&quot;status&quot;:&quot;danger&quot;}"></button>
{{template "signatures".}}