<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="">
<meta name="keywords" content="">
<title>Testnet eGaaS</title>
<script>document.write("<link rel='stylesheet' href='static/css/style.css?v=" + Math.floor((Math.random() * 1000000) + 1) + "'>");</script>
<style>
	#dl_page {
		display:flex;
		flex-flow:column wrap;
		justify-content:center;
		align-items:center;
	}
</style>
<link rel="shortcut icon" href="static/img/favicon.ico" type="image/x-icon">
<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?key=AIzaSyBSoSxKFr6M-iL3RUm-PtHmA2zZTesjNKo"></script>
<script type="text/javascript" src="static/js/app.js"></script>
</head>
<body>
<div id="dl_page">
	<div class="alert alert-warning text-center" style="width:100%; max-width:400px; margin:0px auto;">Тестовый блокчейн. Все данные будут удалены 26/03/17</div>
	<div class="panel panel-default" data-sweet-alert style="width:100%; max-width:400px;">
	 <div class="panel-body">
		<form>
		   <div class="form-group">
			   <input type="text" id="email" class="form-control input-lg" placeholder="Email address">
			   <ul class="parsley-errors-list">
				   <li class="parsley-required">Specify Email</li>
			   </ul>
		   </div>
		   <div class="form-group">
			   <input type="text" id="country" class="form-control input-lg" placeholder="Country">
			   <ul class="parsley-errors-list">
				   <li class="parsley-required">Specify Country name</li>
			   </ul>
		   </div>
		   <div class="form-group">
			   <input type="text" id="currency" class="form-control input-lg" placeholder="Currency">
			   <ul class="parsley-errors-list">
				   <li class="parsley-required">Specify Currency name</li>
			   </ul>
		   </div>
		</form>
	 </div>
	 <div class="panel-footer">
	   <div class="clearfix">
		  <div class="pull-right">
			 <button type="submit" id="send" class="btn btn-lg btn-primary" onclick="preloader(this); return new_state()">Send</button>
		  </div>
	   </div>
	  </div>
	</div>
	<div id="dataError" class="alert alert-danger text-center" style="display:none; width:100%; max-width:400px; margin:0px auto;"></div>
</div>

<script type="text/javascript">
function preloader(elem) {
	obj = $("#" + elem.id).parents("[data-sweet-alert]");
	obj.addClass("whirl");
	
	if (!obj.find(".sk-cube-grid").length) {
		obj.append('<div class="sk-cube-grid"><div class="sk-cube sk-cube1"></div><div class="sk-cube sk-cube2"></div><div class="sk-cube sk-cube3"></div><div class="sk-cube sk-cube4"></div><div class="sk-cube sk-cube5"></div><div class="sk-cube sk-cube6"></div><div class="sk-cube sk-cube7"></div><div class="sk-cube sk-cube8"></div><div class="sk-cube sk-cube9"></div></div>');
	}
}

function checkInput(elem) {
	var val = elem.val();
	
	if (val == "") {
		elem.addClass("parsley-error");
		elem.next().addClass("filled");
	} else {
		elem.removeClass("parsley-error");
		elem.next().removeClass("filled");
	}
}

$(".form-control").on('input', function() {
	$("#dataError").hide();
	checkInput($(this));
})

function new_state() {
    var email = $("#email").val();
    var country = $("#country").val();
    var currency = $("#currency").val();
	var noerror = $(".form-control").length;
	
	$("#dataError").hide();
	
	$(".form-control").each(function() {
		if ($(this).val() == '') {
			$(this).addClass("parsley-error");
			$(this).next().addClass("filled");
			obj.removeClass("whirl");
		} else {
			noerror -= 1;
		}
	})
	
	if (noerror !== 0) {
		return false;
	} else {
		$.post("newstate", {email:  email, country: country, currency: currency},
			function(data) {
				console.log('answer', data );
				if (data.error && data.error.length > 0) {
					if (data.error === "state already exists") {
						$("#country").addClass("parsley-error");
						$("#country").next().addClass("filled").text(data.error);
					} else {
						$("#dataError").text(data.error).show();
					}
					obj.removeClass("whirl");
				} else {
					location.replace({{.Node}}+"/?state="+country+"&pkey=" + data.private);
				}
		}, "JSON");
	}
	
	return false; 
}
</script>


</body>
</html>